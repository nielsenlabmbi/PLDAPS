<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of pldapsTimingTests</title>
  <meta name="keywords" content="pldapsTimingTests">
  <meta name="description" content="outdated, use one of the other functions">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="../index.html">PLDAPS</a> &gt; <a href="index.html">testsuite</a> &gt; pldapsTimingTests.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for PLDAPS/testsuite&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>pldapsTimingTests
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>outdated, use one of the other functions</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>This is a script file. </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="description">outdated, use one of the other functions</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
<!-- crossreference -->

<!-- parameterreference -->
<h2><a name="_cross"></a>PARAMETER USAGE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function uses these parameters:
<ul >
</ul>
This function assigns these parameters:
<ul>
</ul>
<!-- parameterreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre><div id="_line0001" class="line">0001 <span class="comment">%outdated, use one of the other functions</span>
</div><div id="_line0002" class="line">0002 
</div><div id="_line0003" class="line">0003 <span class="comment">%very rough firt draft, need something pretty and well documented</span>
</div><div id="_line0004" class="line">0004 <span class="comment">%% datapixx</span>
</div><div id="_line0005" class="line">0005 dptime=cellfun(@(x) x.timing.datapixxPreciseTime, PDS.data, <span class="string">'UniformOutput'</span>, false);
</div><div id="_line0006" class="line">0006 dptime=vertcat(dptime{:})';
</div><div id="_line0007" class="line">0007 dpfit2=polyfit(dptime(2,:),dptime(1,:),1);
</div><div id="_line0008" class="line">0008 dp2c=@(x) x*dpfit2(1) + dpfit2(2);
</div><div id="_line0009" class="line">0009 
</div><div id="_line0010" class="line">0010 <span class="comment">% [dpfit dpfitS dpfitMU]=polyfit(dptime(2,:),dptime(1,:),1)</span>
</div><div id="_line0011" class="line">0011 <span class="comment">% g=dpfit(1)/dpfitMU(2);</span>
</div><div id="_line0012" class="line">0012 <span class="comment">% h;</span>
</div><div id="_line0013" class="line">0013 
</div><div id="_line0014" class="line">0014 figure;
</div><div id="_line0015" class="line">0015 plot(dptime(1,:), 1000*( dp2c(dptime(2,:)) - dptime(1,:)) )
</div><div id="_line0016" class="line">0016 xlabel(<span class="string">'Datapixx time / s'</span>)
</div><div id="_line0017" class="line">0017 ylabel(<span class="string">'Datapixx time reconstruction error / ms'</span>)
</div><div id="_line0018" class="line">0018 
</div><div id="_line0019" class="line">0019 <span class="comment">%% eyelink</span>
</div><div id="_line0020" class="line">0020 eltime=cellfun(@(x) x.timing.eyelinkStartTime, PDS.data, <span class="string">'UniformOutput'</span>, false);
</div><div id="_line0021" class="line">0021 eltime=vertcat(eltime{:})';
</div><div id="_line0022" class="line">0022 elfit=polyfit(eltime(2,:),eltime(1,:),1);
</div><div id="_line0023" class="line">0023 el2c=@(x) x*elfit(1) + elfit(2);
</div><div id="_line0024" class="line">0024 figure;
</div><div id="_line0025" class="line">0025 plot(eltime(1,:), 1000*( el2c(eltime(2,:)) - eltime(1,:)) )
</div><div id="_line0026" class="line">0026 xlabel(<span class="string">'Eyelink time / s'</span>)
</div><div id="_line0027" class="line">0027 ylabel(<span class="string">'Eyelink time reconstruction error / ms'</span>)
</div><div id="_line0028" class="line">0028 
</div><div id="_line0029" class="line">0029 nrframes=cellfun(@(x) size(x.timing.frameStateChangeTimes,2), PDS.data);
</div><div id="_line0030" class="line">0030 idmaxframes=find(nrframes==max(nrframes));
</div><div id="_line0031" class="line">0031 
</div><div id="_line0032" class="line">0032 <span class="comment">% for idmaxframes=1:length(nrframes)</span>
</div><div id="_line0033" class="line">0033 
</div><div id="_line0034" class="line">0034 <span class="comment">% idmaxframes=84</span>
</div><div id="_line0035" class="line">0035 thisdata=PDS.data{idmaxframes};
</div><div id="_line0036" class="line">0036 
</div><div id="_line0037" class="line">0037 tdELTime=el2c(thisdata.eyelink.samples(1,:)/1000);
</div><div id="_line0038" class="line">0038 tdELData=thisdata.eyelink.samples(5,:);
</div><div id="_line0039" class="line">0039 
</div><div id="_line0040" class="line">0040 
</div><div id="_line0041" class="line">0041 tdDPTime=dp2c(thisdata.datapixx.adc.dataSampleTimes);
</div><div id="_line0042" class="line">0042 tdDPData=thisdata.datapixx.adc.data(1,:);
</div><div id="_line0043" class="line">0043 
</div><div id="_line0044" class="line">0044 
</div><div id="_line0045" class="line">0045 <span class="keyword">try</span>
</div><div id="_line0046" class="line">0046 <span class="comment">% minidx=1;</span>
</div><div id="_line0047" class="line">0047 <span class="comment">% idx=tdELData*0+1;</span>
</div><div id="_line0048" class="line">0048 <span class="comment">% [~,idx(1)]=min(abs(tdDPTime(1:end)-tdELTime(1)));</span>
</div><div id="_line0049" class="line">0049 <span class="comment">% for j=2:length(tdELTime)</span>
</div><div id="_line0050" class="line">0050 <span class="comment">%    [~,id]=min(abs(tdDPTime(idx(j-1):end)-tdELTime(j)));</span>
</div><div id="_line0051" class="line">0051 <span class="comment">%    idx(j)=id+idx(j-1)-1;</span>
</div><div id="_line0052" class="line">0052 <span class="comment">% end</span>
</div><div id="_line0053" class="line">0053 minidx=1;
</div><div id="_line0054" class="line">0054 idx=tdELData*0+1;
</div><div id="_line0055" class="line">0055 [~,idx(1)]=min(abs(tdDPTime(1:end)-tdELTime(1)));
</div><div id="_line0056" class="line">0056 [~,idx(2)]=min(abs(tdDPTime(1:end)-tdELTime(2)));
</div><div id="_line0057" class="line">0057 est_diff_rate=idx(2)-idx(1);
</div><div id="_line0058" class="line">0058 nSamplesEL=length(tdELTime);
</div><div id="_line0059" class="line">0059 nSamplesDP=length(tdDPTime);
</div><div id="_line0060" class="line">0060 <span class="keyword">for</span> j=3:nSamplesEL
</div><div id="_line0061" class="line">0061    newidx=min(idx(j-1)+est_diff_rate,nSamplesDP);
</div><div id="_line0062" class="line">0062    mindiff=min(abs(tdDPTime(newidx)-tdELTime(j)));
</div><div id="_line0063" class="line">0063    
</div><div id="_line0064" class="line">0064    <span class="keyword">if</span> newidx&lt;nSamplesDP
</div><div id="_line0065" class="line">0065        mindiff2=min(abs(tdDPTime(newidx+1)-tdELTime(j)));
</div><div id="_line0066" class="line">0066        <span class="keyword">while</span> mindiff2 &lt; mindiff
</div><div id="_line0067" class="line">0067            newidx=newidx+1;
</div><div id="_line0068" class="line">0068            mindiff=mindiff2;
</div><div id="_line0069" class="line">0069            <span class="keyword">if</span> newidx&lt;nSamplesDP
</div><div id="_line0070" class="line">0070             mindiff2=min(abs(tdDPTime(newidx+1)-tdELTime(j)));
</div><div id="_line0071" class="line">0071            <span class="keyword">else</span>
</div><div id="_line0072" class="line">0072                <span class="keyword">break</span>
</div><div id="_line0073" class="line">0073            <span class="keyword">end</span>
</div><div id="_line0074" class="line">0074        <span class="keyword">end</span>
</div><div id="_line0075" class="line">0075    <span class="keyword">end</span>
</div><div id="_line0076" class="line">0076    
</div><div id="_line0077" class="line">0077    mindiff2=min(abs(tdDPTime(newidx-1)-tdELTime(j)));
</div><div id="_line0078" class="line">0078    <span class="keyword">while</span> mindiff2 &lt; mindiff
</div><div id="_line0079" class="line">0079        newidx=newidx-1;
</div><div id="_line0080" class="line">0080        mindiff=mindiff2;
</div><div id="_line0081" class="line">0081        mindiff2=min(abs(tdDPTime(newidx-1)-tdELTime(j)));
</div><div id="_line0082" class="line">0082    <span class="keyword">end</span>
</div><div id="_line0083" class="line">0083        
</div><div id="_line0084" class="line">0084    idx(j)=newidx;
</div><div id="_line0085" class="line">0085 <span class="keyword">end</span>
</div><div id="_line0086" class="line">0086 dpDownSapleTime=tdDPTime(idx);
</div><div id="_line0087" class="line">0087 dpDownSapleData=tdDPData(idx); 
</div><div id="_line0088" class="line">0088    
</div><div id="_line0089" class="line">0089 maxlag=1000;
</div><div id="_line0090" class="line">0090 [x,l]=xcorr(tdELData,dpDownSapleData,maxlag);
</div><div id="_line0091" class="line">0091 figure;
</div><div id="_line0092" class="line">0092 plot(l,x)
</div><div id="_line0093" class="line">0093 xlabel(<span class="string">'Lag in Eyelink Samples'</span>);
</div><div id="_line0094" class="line">0094 ylabel(<span class="string">'x-correlation'</span>);
</div><div id="_line0095" class="line">0095 
</div><div id="_line0096" class="line">0096 lag=l(x==max(x));
</div><div id="_line0097" class="line">0097 estimated_dp_el_lag=tdELTime(abs(lag)+1)-tdELTime(1);
</div><div id="_line0098" class="line">0098 
</div><div id="_line0099" class="line">0099 fprintf(<span class="string">'estimated lag between Datapixx and Eyelink is %i ms\n'</span>, sign(lag)*round(estimated_dp_el_lag*1000));
</div><div id="_line0100" class="line">0100 <span class="keyword">if</span> lag&gt;0
</div><div id="_line0101" class="line">0101     fprintf(<span class="string">'Datapixx data is ahead of Eyelink data\n'</span>);
</div><div id="_line0102" class="line">0102 <span class="keyword">else</span>
</div><div id="_line0103" class="line">0103     fprintf(<span class="string">'Datapixx data is behind of Eyelink data\n'</span>);
</div><div id="_line0104" class="line">0104 <span class="keyword">end</span>
</div><div id="_line0105" class="line">0105 
</div><div id="_line0106" class="line">0106 <span class="comment">%%other way araound</span>
</div><div id="_line0107" class="line">0107 minidx=1;
</div><div id="_line0108" class="line">0108 idx=tdDPData*0+1;
</div><div id="_line0109" class="line">0109 [~,idx(1)]=min(abs(tdELTime(1:end)-tdDPTime(1)));
</div><div id="_line0110" class="line">0110 [~,idx(2)]=min(abs(tdELTime(1:end)-tdDPTime(2)));
</div><div id="_line0111" class="line">0111 est_diff_rate=idx(2)-idx(1);
</div><div id="_line0112" class="line">0112 nSamplesEL=length(tdELTime);
</div><div id="_line0113" class="line">0113 nSamplesDP=length(tdDPTime);
</div><div id="_line0114" class="line">0114 <span class="keyword">for</span> j=3:nSamplesDP
</div><div id="_line0115" class="line">0115    newidx=min(idx(j-1)+est_diff_rate,nSamplesEL);
</div><div id="_line0116" class="line">0116    mindiff=min(abs(tdELTime(newidx)-tdDPTime(j)));
</div><div id="_line0117" class="line">0117    
</div><div id="_line0118" class="line">0118    <span class="keyword">if</span> newidx&lt;nSamplesEL
</div><div id="_line0119" class="line">0119        mindiff2=min(abs(tdELTime(newidx+1)-tdDPTime(j)));
</div><div id="_line0120" class="line">0120        <span class="keyword">while</span> mindiff2 &lt; mindiff
</div><div id="_line0121" class="line">0121            newidx=newidx+1;
</div><div id="_line0122" class="line">0122            mindiff=mindiff2;
</div><div id="_line0123" class="line">0123            <span class="keyword">if</span> newidx&lt;nSamplesEL
</div><div id="_line0124" class="line">0124             mindiff2=min(abs(tdELTime(newidx+1)-tdDPTime(j)));
</div><div id="_line0125" class="line">0125            <span class="keyword">else</span>
</div><div id="_line0126" class="line">0126                <span class="keyword">break</span>
</div><div id="_line0127" class="line">0127            <span class="keyword">end</span>
</div><div id="_line0128" class="line">0128        <span class="keyword">end</span>
</div><div id="_line0129" class="line">0129    <span class="keyword">end</span>
</div><div id="_line0130" class="line">0130    
</div><div id="_line0131" class="line">0131    <span class="keyword">if</span> newidx&gt;1
</div><div id="_line0132" class="line">0132        mindiff2=min(abs(tdELTime(newidx-1)-tdDPTime(j)));
</div><div id="_line0133" class="line">0133        <span class="keyword">while</span> mindiff2 &lt; mindiff
</div><div id="_line0134" class="line">0134            newidx=newidx-1;
</div><div id="_line0135" class="line">0135            mindiff=mindiff2;
</div><div id="_line0136" class="line">0136            mindiff2=min(abs(tdELTime(newidx-1)-tdDPTime(j)));
</div><div id="_line0137" class="line">0137        <span class="keyword">end</span>
</div><div id="_line0138" class="line">0138    <span class="keyword">end</span>
</div><div id="_line0139" class="line">0139        
</div><div id="_line0140" class="line">0140    idx(j)=newidx;
</div><div id="_line0141" class="line">0141 <span class="keyword">end</span>
</div><div id="_line0142" class="line">0142 elDownSapleTime=tdELTime(idx);
</div><div id="_line0143" class="line">0143 elDownSapleData=tdELData(idx); 
</div><div id="_line0144" class="line">0144    
</div><div id="_line0145" class="line">0145 maxlag=1000;
</div><div id="_line0146" class="line">0146 [x,l]=xcorr(tdDPData,elDownSapleData,maxlag);
</div><div id="_line0147" class="line">0147 figure;
</div><div id="_line0148" class="line">0148 plot(l,x)
</div><div id="_line0149" class="line">0149 xlabel(<span class="string">'Lag in Datapixx Samples'</span>);
</div><div id="_line0150" class="line">0150 ylabel(<span class="string">'x-correlation'</span>);
</div><div id="_line0151" class="line">0151 
</div><div id="_line0152" class="line">0152 lag=l(x==max(x));
</div><div id="_line0153" class="line">0153 estimated_el_DP_lag=tdDPTime(abs(lag)+1)-tdDPTime(1);
</div><div id="_line0154" class="line">0154 
</div><div id="_line0155" class="line">0155 fprintf(<span class="string">'estimated lag between Eyelink and Datapixx is %i ms\n'</span>, sign(lag)*round(estimated_el_DP_lag*1000));
</div><div id="_line0156" class="line">0156 <span class="keyword">if</span> lag&gt;0
</div><div id="_line0157" class="line">0157     fprintf(<span class="string">'Datapixx data is behind of Eyelink data\n'</span>);
</div><div id="_line0158" class="line">0158 <span class="keyword">else</span>
</div><div id="_line0159" class="line">0159     fprintf(<span class="string">'Datapixx data is ahead of Eyelink data\n'</span>);
</div><div id="_line0160" class="line">0160 <span class="keyword">end</span>
</div><div id="_line0161" class="line">0161 
</div><div id="_line0162" class="line">0162 allags(idmaxframes)=lag;
</div><div id="_line0163" class="line">0163 <span class="keyword">catch</span>
</div><div id="_line0164" class="line">0164     allags(idmaxframes)=NaN;
</div><div id="_line0165" class="line">0165 <span class="keyword">end</span>
</div><div id="_line0166" class="line">0166 
</div><div id="_line0167" class="line">0167 <span class="comment">% end</span>
</div><div id="_line0168" class="line">0168 <span class="comment">%</span>
</div><div id="_line0169" class="line">0169 <span class="comment">% minidx=1;</span>
</div><div id="_line0170" class="line">0170 <span class="comment">% idx=tdELData*0+1;</span>
</div><div id="_line0171" class="line">0171 <span class="comment">% [~,idx(1)]=min(abs(tdDPTime(1:end)-tdELTime(1)+lag/1000));</span>
</div><div id="_line0172" class="line">0172 <span class="comment">% [~,idx(2)]=min(abs(tdDPTime(1:end)-tdELTime(2)+lag/1000));</span>
</div><div id="_line0173" class="line">0173 <span class="comment">% for j=2:length(tdELTime)</span>
</div><div id="_line0174" class="line">0174 <span class="comment">%    [~,id]=min(abs(tdDPTime(idx(j-1):end)-tdELTime(j)+lag/1000));</span>
</div><div id="_line0175" class="line">0175 <span class="comment">%    idx(j)=id+idx(j-1)-1;</span>
</div><div id="_line0176" class="line">0176 <span class="comment">% end</span>
</div><div id="_line0177" class="line">0177 <span class="comment">% dpDownSapleTime=tdDPTime(idx)+lag/1000;</span>
</div><div id="_line0178" class="line">0178 <span class="comment">% dpDownSapleData=tdDPData(idx);</span>
</div><div id="_line0179" class="line">0179 <span class="comment">%</span>
</div><div id="_line0180" class="line">0180 lagseconds=median(diff(tdELTime))*lag;
</div><div id="_line0181" class="line">0181 minidx=1;
</div><div id="_line0182" class="line">0182 idx=tdELData*0+1;
</div><div id="_line0183" class="line">0183 [~,idx(1)]=min(abs(tdDPTime(1:end)-tdELTime(1)+lagseconds));
</div><div id="_line0184" class="line">0184 [~,idx(2)]=min(abs(tdDPTime(1:end)-tdELTime(2)+lagseconds));
</div><div id="_line0185" class="line">0185 est_diff_rate=idx(2)-idx(1);
</div><div id="_line0186" class="line">0186 nSamplesEL=length(tdELTime);
</div><div id="_line0187" class="line">0187 nSamplesDP=length(tdDPTime);
</div><div id="_line0188" class="line">0188 <span class="keyword">for</span> j=3:nSamplesEL
</div><div id="_line0189" class="line">0189    newidx=min(idx(j-1)+est_diff_rate,nSamplesDP);
</div><div id="_line0190" class="line">0190    mindiff=min(abs(tdDPTime(newidx)-tdELTime(j)+lagseconds));
</div><div id="_line0191" class="line">0191    
</div><div id="_line0192" class="line">0192    <span class="keyword">if</span> newidx&lt;nSamplesDP
</div><div id="_line0193" class="line">0193        mindiff2=min(abs(tdDPTime(newidx+1)-tdELTime(j)+lagseconds));
</div><div id="_line0194" class="line">0194        <span class="keyword">while</span> mindiff2 &lt; mindiff
</div><div id="_line0195" class="line">0195            newidx=newidx+1;
</div><div id="_line0196" class="line">0196            mindiff=mindiff2;
</div><div id="_line0197" class="line">0197            <span class="keyword">if</span> newidx&lt;nSamplesDP
</div><div id="_line0198" class="line">0198             mindiff2=min(abs(tdDPTime(newidx+1)-tdELTime(j)+lagseconds));
</div><div id="_line0199" class="line">0199            <span class="keyword">else</span>
</div><div id="_line0200" class="line">0200                <span class="keyword">break</span>;
</div><div id="_line0201" class="line">0201            <span class="keyword">end</span>
</div><div id="_line0202" class="line">0202                
</div><div id="_line0203" class="line">0203        <span class="keyword">end</span>
</div><div id="_line0204" class="line">0204    <span class="keyword">end</span>
</div><div id="_line0205" class="line">0205    
</div><div id="_line0206" class="line">0206    mindiff2=min(abs(tdDPTime(newidx-1)-tdELTime(j)+lagseconds));
</div><div id="_line0207" class="line">0207    <span class="keyword">while</span> mindiff2 &lt; mindiff
</div><div id="_line0208" class="line">0208        newidx=newidx-1;
</div><div id="_line0209" class="line">0209        mindiff=mindiff2;
</div><div id="_line0210" class="line">0210        mindiff2=min(abs(tdDPTime(newidx-1)-tdELTime(j)+lagseconds));
</div><div id="_line0211" class="line">0211    <span class="keyword">end</span>
</div><div id="_line0212" class="line">0212        
</div><div id="_line0213" class="line">0213    idx(j)=newidx;
</div><div id="_line0214" class="line">0214 <span class="keyword">end</span>
</div><div id="_line0215" class="line">0215 dpDownSapleTime=tdDPTime(idx)+lagseconds;
</div><div id="_line0216" class="line">0216 dpDownSapleData=tdDPData(idx); 
</div><div id="_line0217" class="line">0217    
</div><div id="_line0218" class="line">0218 
</div><div id="_line0219" class="line">0219 
</div><div id="_line0220" class="line">0220 n=tdELData&gt;-3000;
</div><div id="_line0221" class="line">0221 
</div><div id="_line0222" class="line">0222 scaling=polyfit(dpDownSapleData(n),tdELData(n),1)
</div><div id="_line0223" class="line">0223 figure;
</div><div id="_line0224" class="line">0224 plot(tdELTime,tdELData);
</div><div id="_line0225" class="line">0225 hold on;
</div><div id="_line0226" class="line">0226 plot(dpDownSapleTime,scaling(1)*dpDownSapleData+scaling(2),<span class="string">'g'</span>)
</div><div id="_line0227" class="line">0227 
</div><div id="_line0228" class="line">0228 
</div><div id="_line0229" class="line">0229 
</div></pre></div>
<hr><address>Generated by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005
<br>
check <strong><a href="../../index.html">here</a></strong> date of last update.
<br></address>
</body>
</html>